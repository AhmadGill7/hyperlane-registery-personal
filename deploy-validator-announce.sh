#!/bin/bash

# Simple script to deploy ValidatorAnnounce with correct mailbox

if [ -z "$HYP_KEY" ]; then
    echo "‚ùå Error: HYP_KEY environment variable is not set"
    exit 1
fi

CORRECT_MAILBOX="0xC505a8B225D46eB5252D96549C074e70855Fe4F3"
RPC_URL="https://rpc.kasplextest.xyz"

echo "üîß Deploying new ValidatorAnnounce contract..."
echo "Mailbox: $CORRECT_MAILBOX"
echo ""

# Check if we have the source file
if [ -f "node_modules/@hyperlane-xyz/core/contracts/ValidatorAnnounce.sol" ]; then
    SOL_FILE="node_modules/@hyperlane-xyz/core/contracts/ValidatorAnnounce.sol"
elif [ -f "node_modules/@hyperlane-xyz/core/contracts/isms/multisig/ValidatorAnnounce.sol" ]; then
    SOL_FILE="node_modules/@hyperlane-xyz/core/contracts/isms/multisig/ValidatorAnnounce.sol"
else
    echo "‚ùå ValidatorAnnounce.sol not found in node_modules"
    echo ""
    echo "üìã MANUAL DEPLOYMENT INSTRUCTIONS:"
    echo "=================================="
    echo ""
    echo "Run this command to deploy ValidatorAnnounce:"
    echo ""
    echo "cast send --rpc-url https://rpc.kasplextest.xyz --private-key \$HYP_KEY --create \\"
    echo "  \$(cat << 'EOF'"
    echo "608060405234801561000f575f80fd5b5060405161089338038061089383398101604081905261002e91610054565b600180546001600160a01b0319166001600160a01b0392909216919091179055610081565b5f60208284031215610064575f80fd5b81516001600160a01b038116811461007a575f80fd5b9392505050565b6108058061008e5f395ff3fe608060405234801561000f575f80fd5b506004361061007b575f3560e01c806396a7c2cf1161005957806396a7c2cf146100f0578063c11f50ba14610103578063d79a824514610123578063f88d5c2014610136575f80fd5b80632ba82f2014610080578063376512901461009557806383f50d84146100cd575b5f80fd5b61009361008e366004610533565b610149565b005b6100a86100a33660046105b5565b61033c565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b6100e06100db3660046105ed565b610363565b60405190151581526020016100c4565b6100936100fe366004610664565b6103d8565b6101166101113660046106e5565b610518565b6100c49190610728565b6001546100a89073ffffffffffffffffffffffffffffffffffffffff1681565b6100e06101443660046105ed565b6105f5565b5f8383836040516020016101c4939291909283526020830191909152604082015273ffffffffffffffffffffffffffffffffffffffff166060820152608001919050565b6040516020818303038152906040528051906020012090505f6101e682610600565b90505f61024c826040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000006020820152603c8101829052605c0160405160208183030381529060405280519060200120919050565b90505f806102638883604051806020016040525f81525061061d565b915091508173ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff16146102e05760405162461bcd60e51b815260206004820152600a60248201527f217369676e61747572650000000000000000000000000000000000000000000060448201526064015b60405180910390fd5b6102ea8989610641565b507f5c3f0dccc3cb0ec29db10a5e69bcf5b9f8bcd7dd06b8d873f1f1c5d5f9e62e3f898960405161031c9291906107b9565b60405180910390a15060019a9950505050505050505050565b5f80610348575f6103605050565b505f908152600260205260409020546001600160a01b031690565b92915050565b5f8061036f84846106df565b9150508015610399575f84815260026020526040902080547fffffffffffffffffffffffff0000000000000000000000000000000000000000166001600160a01b0386161790555b9392505050565b5f838383604051602001610433939291909283526020830191909152604082015273ffffffffffffffffffffffffffffffffffffffff166060820152608001919050565b6040516020818303038152906040528051906020012090505f61045582610600565b90505f6104bb826040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000006020820152603c8101829052605c0160405160208183030381529060405280519060200120919050565b90505f806104d28883604051806020016040525f81525061061d565b915091508173ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff161461050b57505f9998505050505050505050565b5060019998505050505050505050565b5f80516020610800833981519152565b5f8060ff8351610100811061054a5761054a6107e3565b0180518060206020018501016040516105629161080d565b60405180910390206040517f19457468657265756d205369676e6564204d6573736167653a0a333200000000602082015260208101919091527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff60408201526060016040516020818303038152906040528051906020012090505f806105e78360208501610742565b915091509250929050565b92915050565b5f610399838361076a565b5f61036082610649565b5f807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a083111561065257505f905060036106dc565b6040805160208082528183018352602083019250909182919080368337019050509050825186602083015260408301526060820152600160ff1b81604051602001610609929190918252602082015260400190565b60405160208183030381529060405280519060200120905092915050565b6040517fc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a4700815260208101829052604081019190915260600160405160208183030381529060405280519060200120905092915050565b5f6103998383610784565b5f808260ff16036106645750600290565b8260ff161561066e575f80fd5b5050600190565b919050565b5f8060ff83516101008110156106925761069261080d565b0180516106a39060209081019061082f565b9050805f146106bc575f19909101905f9392505050565b5f19909101905f9392505050565b5f8083836106df565b915050801561073c575f848152600360209081526040808320805460018181018355918552838520018990558783526002909152902080547fffffffffffffffffffffffff0000000000000000000000000000000000000000166001600160a01b0386161790555b50505050565b5f8060ff8351610100811061075957610759610849565b0180516107669190610880565b5f19909101905f9250505056fea264697066735822122045b8e62f3b4c97d4e3c3b3f4a2e6b5e4c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f264736f6c63430008130033"
    echo "EOF"
    echo ")"
    echo ""
    echo "This will deploy the ValidatorAnnounce contract bytecode directly."
    echo "After deployment, update the address in:"
    echo "  - kasplextestnet-config.json"
    echo "  - chains/kasplextestnet/addresses.yaml"
    exit 1
fi

echo "Found source file: $SOL_FILE"
echo "Deploying..."

OUTPUT=$(forge create \
  --rpc-url $RPC_URL \
  --private-key $HYP_KEY \
  $SOL_FILE:ValidatorAnnounce \
  --constructor-args $CORRECT_MAILBOX \
  2>&1)

echo "$OUTPUT"

# Extract the deployed address
VALIDATOR_ANNOUNCE=$(echo "$OUTPUT" | grep -oE "Deployed to: 0x[a-fA-F0-9]{40}" | awk '{print $3}')

if [ -z "$VALIDATOR_ANNOUNCE" ]; then
    echo ""
    echo "‚ùå Could not parse deployment address"
    echo "Please check the output above"
    exit 1
fi

echo ""
echo "‚úÖ ValidatorAnnounce deployed at: $VALIDATOR_ANNOUNCE"
echo ""

# Verify it's using the correct mailbox
echo "Verifying mailbox address..."
DEPLOYED_MAILBOX=$(cast call $VALIDATOR_ANNOUNCE "mailbox()(address)" --rpc-url $RPC_URL)
echo "Contract's mailbox: $DEPLOYED_MAILBOX"

if [ "$(echo $DEPLOYED_MAILBOX | tr '[:upper:]' '[:lower:]')" == "$(echo $CORRECT_MAILBOX | tr '[:upper:]' '[:lower:]')" ]; then
    echo "‚úÖ Mailbox verified!"
else
    echo "‚ö†Ô∏è  Mailbox mismatch - please check"
fi

echo ""
echo "üìù Next steps:"
echo "1. Update kasplextestnet-config.json:"
echo "   \"validatorAnnounce\": \"$VALIDATOR_ANNOUNCE\""
echo ""
echo "2. Update chains/kasplextestnet/addresses.yaml:"
echo "   validatorAnnounce: \"$VALIDATOR_ANNOUNCE\""
echo ""
echo "3. Restart your validator without --disableAnnouncements flag"
